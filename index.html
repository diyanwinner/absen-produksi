<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#022c22">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Absen Produksi (Berkah Edition)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

  <style>
    :root {
      /* === PALET WARNA ISLAMI (Emerald & Gold) === */
      --bg-body: #022c22;       /* Hijau Gelap Sekali */
      --bg-card: #064e3b;       /* Hijau Emerald */
      --bg-input: #065f46;      /* Hijau Input */
      
      --text-main: #ecfdf5;     /* Putih Kehijauan */
      --text-muted: #a7f3d0;    /* Hijau Muda Pucat */
      
      --gold: #d4af37;          /* EMAS (Primary) */
      --gold-hover: #b4942b;
      
      --success: #10b981;       
      --warn: #fbbf24;       
      --danger: #ef4444;        
      
      --border: #d4af37;        /* Border Emas */
      --radius: 12px;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    
    body { 
      margin: 0; 
      background-color: var(--bg-body);
      /* Pattern Halus */
      background-image: radial-gradient(circle at 2px 2px, rgba(212, 175, 55, 0.15) 1px, transparent 0);
      background-size: 30px 30px;
      color: var(--text-main); 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      font-size: 14px; 
      line-height: 1.5; 
    }
    
    /* Layout Utama */
    .wrap { max-width:1200px; margin:0 auto; padding:20px; }

    /* Header Bismillah */
    .bismillah {
      font-family: 'Amiri', serif;
      font-size: 2.2rem;
      color: var(--gold);
      text-align: center;
      margin-bottom: 0.2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .slogan {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-style: italic;
      margin-bottom: 2rem;
    }
    
    /* Header Card */
    .header-card {
      background: var(--bg-card); 
      border: 1px solid var(--gold); 
      border-radius: var(--radius);
      padding: 20px; margin-bottom: 20px; 
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .controls { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:16px; align-items:end; }
    
    .form-group { display:flex; flex-direction:column; gap:6px; }
    .form-group label { font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
    
    input, select {
      background: var(--bg-input); 
      border: 1px solid #374151; 
      color: var(--text-main);
      padding: 10px 12px; border-radius: 8px; font-size: 14px; width: 100%; outline: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }

    /* Tabs Work Center */
    .tabs { 
      background: var(--bg-input); 
      padding: 4px; border-radius: 10px; 
      border: 1px solid #374151; 
      display: flex; 
    }
    .tab {
      flex: 1; border: none; background: transparent; color: var(--text-muted);
      padding: 8px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .tab.active { 
      background: var(--gold); 
      color: #022c22; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
      font-weight: 800; 
    }

    /* Badge Info */
    .info-bar { 
      margin-top: 16px; display: flex; justify-content: space-between; align-items: center; 
      border-top: 1px solid rgba(212, 175, 55, 0.3); padding-top: 16px; flex-wrap: wrap; gap: 10px; 
    }
    .badge { 
      background: rgba(16, 185, 129, 0.2); color: var(--success); 
      padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; 
      border: 1px solid var(--success); 
    }
    .shortcuts { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; }
    .shortcuts b { color: var(--gold); background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }

    /* Grid Table Container */
    .grid-card {
      background: var(--bg-card); 
      border: 1px solid var(--gold); 
      border-radius: var(--radius);
      overflow: hidden; 
      box-shadow: var(--shadow);
    }
    
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    
    th {
      background: #022c22; color: var(--gold); 
      font-weight: 700; font-size: 12px;
      text-transform: uppercase; text-align: left; padding: 14px 16px;
      border-bottom: 2px solid var(--gold);
    }
    td { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(212, 175, 55, 0.05); }

    /* Input Cells */
    input.cell {
      background: rgba(0,0,0,0.2); 
      border: 1px solid transparent; 
      text-align: center;
      font-weight: 700; color: var(--gold); width: 100%; max-width: 80px;
    }
    input.cell:focus { 
      border-color: var(--gold); 
      background: var(--bg-input); 
      color: var(--text-main);
    }
    
    .process-name { font-weight: 600; color: var(--text-main); }
    .total-cell { font-weight: 800; color: var(--success); text-align: center; font-size: 1.1em; }

    /* Footer Totals */
    tfoot tr { background: #022c22; font-weight: 700; }
    tfoot td { color: var(--gold); text-align: center; padding: 16px; font-size: 15px; border-top: 2px solid var(--gold); }
    tfoot td:first-child { text-align: right; color: var(--text-muted); }

    /* Action Bar */
    .actions {
      padding: 16px; background: #022c22; border-top: 1px solid var(--gold);
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
    }
    
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      background: var(--bg-input); border: 1px solid var(--gold); color: var(--text-main);
      padding: 10px 16px; border-radius: 50px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; font-size: 13px;
    }
    .btn:hover { background: var(--gold); color: #022c22; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    
    .btn.primary { 
      background: linear-gradient(to bottom, #d4af37, #b4942b); 
      border: none; color: #022c22; 
      box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
    }
    .btn.primary:hover { filter: brightness(1.1); }
    
    .btn.success { border-color: var(--success); color: var(--success); background: transparent; }
    .btn.success:hover { background: var(--success); color: #022c22; }
    
    .btn.warn { border-color: var(--warn); color: var(--warn); background: transparent; }
    .btn.warn:hover { background: var(--warn); color: #451a03; }

    /* Rekap Section */
    #rekapWrap { margin-top: 30px; border-color: var(--warn); box-shadow: 0 0 20px rgba(251, 191, 36, 0.1); }
    .rekap-header {
      background: rgba(251, 191, 36, 0.1); color: var(--warn); padding: 12px 16px;
      font-weight: 700; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--warn);
    }

    /* Shift Pills */
    .shift-status { display: flex; gap: 8px; }
    .pill {
      font-size: 11px; padding: 2px 8px; border-radius: 10px; border: 1px solid var(--text-muted);
      background: transparent; opacity: 0.7; color: var(--text-muted);
    }
    .pill.filled { opacity: 1; border-color: var(--success); color: var(--success); font-weight: bold; background: rgba(16, 185, 129, 0.1); }
    .pill.empty { opacity: 1; border-color: var(--danger); color: var(--danger); }

    /* Toast */
    #updateToast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--bg-card); border: 1px solid var(--gold); padding: 12px 20px;
      border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: none; align-items: center; gap: 12px; z-index: 999; color: var(--gold);
    }
    #btnReload { background: var(--gold); border: none; color: #022c22; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 700; }

    @media (max-width: 600px) {
      .wrap { padding: 12px; }
      .header-card, .grid-card { padding: 0; border-radius: 0; border-left: 0; border-right: 0; }
      .header-card { padding: 16px; border-radius: 12px; border: 1px solid var(--gold); }
      .shortcuts { display: none; }
      th, td { padding: 10px; font-size: 13px; }
      input.cell { max-width: 60px; padding: 8px 4px; }
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="bismillah">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</div>
  <div class="slogan">"Insya Allah Memudahkan Pekerjaan & Rezeki Lancar"</div>

  <div class="header-card">
    <div class="controls">
      <div class="form-group">
        <label>Tanggal Produksi</label>
        <input type="date" id="tgl">
      </div>
      <div class="form-group">
        <label>Shift Kerja</label>
        <select id="shift">
          <option value="1">Shift 1 (Pagi)</option>
          <option value="2">Shift 2 (Siang)</option>
          <option value="3">Shift 3 (Malam)</option>
        </select>
      </div>
      <div class="form-group" style="flex:1.5">
        <label>Work Center</label>
        <div class="tabs">
          <button class="tab active" data-center="Injection">Injection</button>
          <button class="tab" data-center="Assembly">Assembly</button>
        </div>
      </div>
    </div>
    
    <div class="info-bar">
      <span class="badge" id="keyPreview">Loading...</span>
      <div class="shortcuts">
        <span><b>Ctrl+S</b> Simpan</span>
        <span><b>Ctrl+E</b> Export JSON</span>
      </div>
    </div>
  </div>

  <div class="grid-card">
    <div class="table-wrap">
      <table id="grid">
        <thead>
          <tr>
            <th style="width:50px; text-align:center;">#</th>
            <th>Proses / Bagian</th>
            <th style="text-align:center; width:100px;">Tetap</th>
            <th style="text-align:center; width:100px;">Kontrak</th>
            <th style="text-align:center; width:100px;">Yayasan</th>
            <th style="text-align:center; width:80px;">Total</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td></td>
            <td style="text-align:right;">TOTAL SHIFT INI</td>
            <td id="totTetap">0</td>
            <td id="totKontrak">0</td>
            <td id="totYayasan">0</td>
            <td id="totAll" style="color:var(--success); font-weight:800;">0</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="actions">
      <button class="btn success" id="btnSave">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
        Simpan Data
      </button>
      
      <div style="flex:1"></div>

      <button class="btn primary" id="btnExportXLSX">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
        Export Excel (Laporan)
      </button>

      <button class="btn" id="btnExportJSON">JSON</button>
      <button class="btn" id="btnExportCSV">CSV</button>
      <button class="btn warn" id="btnRekap">Lihat Rekap Harian</button>
    </div>
  </div>

  <div class="grid-card" id="rekapWrap" style="display:none;">
    <div class="rekap-header">
      <span>REKAPITULASI HARIAN (Shift 1 + 2 + 3)</span>
      <div id="shiftStatus" class="shift-status"></div>
    </div>
    
    <div class="table-wrap">
      <table id="rekapTable">
        <thead>
          <tr>
            <th style="width:50px;">#</th>
            <th>Proses</th>
            <th style="text-align:center;">Tetap</th>
            <th style="text-align:center;">Kontrak</th>
            <th style="text-align:center;">Yayasan</th>
            <th style="text-align:center;">Grand Total</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td></td>
            <td style="text-align:right;">TOTAL HARIAN</td>
            <td id="rTotTetap">0</td>
            <td id="rTotKontrak">0</td>
            <td id="rTotYayasan">0</td>
            <td id="rTotTotal">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <div class="actions">
      <span style="font-size:12px; color:var(--text-muted);" id="rekapTitle"></span>
      <div style="flex:1"></div>
      <button class="btn" id="btnRekapCSV">Download Rekap CSV</button>
      <button class="btn" onclick="document.getElementById('rekapWrap').style.display='none'">Tutup</button>
    </div>
  </div>
</div>

<div id="updateToast">
  <span>Update baru tersedia!</span>
  <button id="btnReload">Refresh</button>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  window.APP_VERSION = '2025-12-05-FIX';

  const SUPABASE_URL  = 'https://xpcmrdkdnbqdohjjqxds.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwY21yZGtkbmJxZG9oampxeGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5Mzc2ODAsImV4cCI6MjA3ODUxMzY4MH0.ZLEzHKaWjic5vn_zAiD6S2jZgU-s2E-Z8Kbd4M66zE8';
  const supa = createClient(SUPABASE_URL, SUPABASE_ANON);

  const $tgl   = document.getElementById('tgl');
  const $shift = document.getElementById('shift');
  const $tabs  = document.querySelectorAll('.tab');
  const $key   = document.getElementById('keyPreview');
  const $gridBody = document.querySelector('#grid tbody');

  let CENTER = 'Injection';
  let PROC = [];
  let ROWS = [];

  const params = new URLSearchParams(location.search);
  const getTodayLocalISO = () => {
    const d = new Date();
    const tzOffset = d.getTimezoneOffset() * 60000;
    return new Date(Date.now() - tzOffset).toISOString().slice(0,10);
  };
  const todayISO = getTodayLocalISO();
  $tgl.value = params.get('today') === '1' ? todayISO : (params.get('date') || todayISO);

  $tabs.forEach(b=>b.addEventListener('click', ()=>{
    $tabs.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    CENTER = b.dataset.center;
    refresh();
  }));
  $tgl.addEventListener('change', refresh);
  $shift.addEventListener('change', refresh);

  document.getElementById('btnSave').onclick        = saveToServer;
  document.getElementById('btnExportJSON').onclick  = ()=>downloadJSON(currentPayload(),'shift.json');
  document.getElementById('btnExportCSV').onclick   = ()=>downloadCSV(rowsToCSV(ROWS),'shift.csv');
  document.getElementById('btnRekap').onclick       = renderRekap;
  document.getElementById('btnRekapCSV').onclick    = ()=>{
    const csv = rekapToCSV(_lastRekap.rows, _lastRekap.totals);
    downloadCSV(csv,'rekap.csv');
  };

  // --- LOGIC BARU: EXPORT EXCEL ---
  document.getElementById('btnExportXLSX').onclick = exportToExcelStyled;

  window.addEventListener('keydown', e=>{
    if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveToServer(); }
    if(e.ctrlKey && e.key.toLowerCase()==='e'){ e.preventDefault(); downloadJSON(currentPayload(),'shift.json'); }
  });

  async function fetchProcesses(center){
    try {
      const { data, error } = await supa.from('processes').select('id,name,sort').eq('center', center).order('sort', { ascending:true });
      if(error) throw error; return data;
    } catch(e) {
      console.error(e);
      $key.textContent = "Error koneksi";
      return [];
    }
  }

  async function fetchAttendance(dateISO, shift, center){
    try {
      const { data, error } = await supa.from('attendance').select('process_id,tetap,kontrak,yayasan,processes(name,sort)').eq('work_date', dateISO).eq('shift', shift).eq('center', center).order('processes(sort)');
      if(error) throw error;
      return data.map(r=>({
        process_id: r.process_id, name: r.processes.name, tetap: r.tetap, kontrak: r.kontrak, yayasan: r.yayasan,
        total: (r.tetap||0)+(r.kontrak||0)+(r.yayasan||0)
      }));
    } catch(e) { return []; }
  }

  async function upsertAttendance(dateISO, shift, center, rows){
    const payload = rows.map(r=>({
      work_date: dateISO, shift: Number(shift), center, process_id: r.process_id,
      tetap: Number(r.tetap||0), kontrak: Number(r.kontrak||0), yayasan: Number(r.yayasan||0)
    }));
    const { error } = await supa.from('attendance').upsert(payload, { onConflict:'work_date,shift,center,process_id' });
    if(error) throw error;
  }

  async function fetchRekap(dateISO, center){
    const { data, error } = await supa.from('daily_rekap').select('*').eq('work_date', dateISO).eq('center', center).order('process_sort', { ascending:true });
    if(error) throw error;
    return data.map(r=>({ process_id:r.process_id, name:r.process_name, tetap:r.tetap, kontrak:r.kontrak, yayasan:r.yayasan, total:r.total }));
  }

  async function refresh(){
    $key.textContent = "Loading...";
    PROC = await fetchProcesses(CENTER);
    ROWS = PROC.map(p=>({process_id:p.id,name:p.name,tetap:null,kontrak:null,yayasan:null,total:0}));
    
    if(PROC.length > 0) {
      const serverRows = await fetchAttendance($tgl.value, $shift.value, CENTER);
      const byPid = Object.fromEntries(serverRows.map(r=>[r.process_id, r]));
      ROWS = ROWS.map(r => byPid[r.process_id] ? byPid[r.process_id] : r);
      renderGrid();
      $key.textContent = `${$tgl.value} â€¢ Shift ${$shift.value} â€¢ ${CENTER}`;
    } else {
       $gridBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Gagal memuat data / Data kosong</td></tr>';
    }
    document.getElementById('rekapWrap').style.display='none';
  }

  function renderGrid() {
    $gridBody.innerHTML = '';
    ROWS.forEach((r, idx) => {
      const val = k => (r[k] ? r[k] : '');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center; color:var(--text-muted);">${idx + 1}</td>
        <td class="process-name">${escapeHTML(r.name)}</td>
        <td style="text-align:center;"><input type="number" class="cell" data-i="${idx}" data-k="tetap" value="${val('tetap')}" placeholder="-"></td>
        <td style="text-align:center;"><input type="number" class="cell" data-i="${idx}" data-k="kontrak" value="${val('kontrak')}" placeholder="-"></td>
        <td style="text-align:center;"><input type="number" class="cell" data-i="${idx}" data-k="yayasan" value="${val('yayasan')}" placeholder="-"></td>
        <td class="total-cell" id="t${idx}">${Number(r.tetap||0)+Number(r.kontrak||0)+Number(r.yayasan||0)}</td>
      `;
      $gridBody.appendChild(tr);
    });
    
    $gridBody.querySelectorAll('input.cell').forEach(inp => {
      inp.addEventListener('input', () => {
        const i = Number(inp.dataset.i);
        const k = inp.dataset.k;
        ROWS[i][k] = inp.value === '' ? null : Number(inp.value);
        ROWS[i].total = Number(ROWS[i].tetap||0) + Number(ROWS[i].kontrak||0) + Number(ROWS[i].yayasan||0);
        document.getElementById('t' + i).textContent = ROWS[i].total;
        updateTotals();
      });
    });
    updateTotals();
  }

  async function saveToServer(){
    const btn = document.getElementById('btnSave');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Menyimpan...';
    try{
      await upsertAttendance($tgl.value, $shift.value, CENTER, ROWS);
      toast('Alhamdulillah Data Tersimpan! âœ…');
    }catch(e){
      console.error(e);
      alert('Gagal menyimpan ke server');
    }finally{
      btn.innerHTML = oldText;
    }
  }

  function updateTotals() {
    let tTetap=0, tKon=0, tYay=0, tAll=0;
    ROWS.forEach(r => {
      tTetap += Number(r.tetap||0); tKon += Number(r.kontrak||0);
      tYay += Number(r.yayasan||0); tAll += Number(r.total||0);
    });
    document.getElementById('totTetap').textContent = tTetap;
    document.getElementById('totKontrak').textContent = tKon;
    document.getElementById('totYayasan').textContent = tYay;
    document.getElementById('totAll').textContent = tAll;
  }

  async function checkShiftsFilled(dateISO, center){
    const { data, error } = await supa.from('attendance').select('shift').eq('work_date', dateISO).eq('center', center);
    if(error) return null;
    const found = new Set(data.map(r => Number(r.shift)));
    return { 1: found.has(1), 2: found.has(2), 3: found.has(3) };
  }

  let _lastRekap = null;
  async function renderRekap(){
    const date = $tgl.value;
    const center = CENTER;
    const rows = await fetchRekap(date, center);
    const tbody = document.querySelector('#rekapTable tbody');
    document.getElementById('rekapTitle').textContent = `Data: ${date} â€¢ ${center}`;
    
    tbody.innerHTML = '';
    let totTet=0, totKon=0, totYay=0, totAll=0;
    rows.forEach((r,i)=>{
      totTet+=r.tetap; totKon+=r.kontrak; totYay+=r.yayasan; totAll+=r.total;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center;">${i+1}</td>
        <td>${escapeHTML(r.name)}</td>
        <td style="text-align:center;">${r.tetap}</td>
        <td style="text-align:center;">${r.kontrak}</td>
        <td style="text-align:center;">${r.yayasan}</td>
        <td style="text-align:center; font-weight:700;">${r.total}</td>`;
      tbody.appendChild(tr);
    });
    
    document.getElementById('rTotTetap').textContent = totTet;
    document.getElementById('rTotKontrak').textContent = totKon;
    document.getElementById('rTotYayasan').textContent = totYay;
    document.getElementById('rTotTotal').textContent = totAll;

    _lastRekap = { rows, totals:{tetap:totTet, kontrak:totKon, yayasan:totYay, total:totAll} };

    const status = await checkShiftsFilled(date, center);
    const statusBox = document.getElementById('shiftStatus');
    statusBox.innerHTML = '';
    [1,2,3].forEach(s => {
      const isFilled = status && status[s];
      statusBox.innerHTML += `<span class="pill ${isFilled?'filled':'empty'}">Shift ${s} ${isFilled?'âœ“':''}</span>`;
    });

    document.getElementById('rekapWrap').style.display='block';
    document.getElementById('rekapWrap').scrollIntoView({behavior:'smooth'});
  }

  function currentPayload(){
    return { work_date:$tgl.value, shift:$shift.value, center:CENTER, rows: ROWS.map(({process_id,name,tetap,kontrak,yayasan,total})=>({process_id,name,tetap,kontrak,yayasan,total})) };
  }
  function rowsToCSV(rows){
    const lines = [['No','Proses','Tetap','Kontrak','Yayasan','Total'].join(',')];
    rows.forEach((r,i)=>lines.push([i+1, csv(r.name), Number(r.tetap||0), Number(r.kontrak||0), Number(r.yayasan||0), Number(r.total||0)].join(',')));
    return lines.join('\n');
  }
  function rekapToCSV(rows,tot){
    const lines = [['No','Proses','Tetap','Kontrak','Yayasan','Total'].join(',')];
    rows.forEach((r,i)=>lines.push([i+1, csv(r.name), r.tetap, r.kontrak, r.yayasan, r.total].join(',')));
    lines.push([ '', 'TOTAL', tot.tetap, tot.kontrak, tot.yayasan, tot.total ].join(','));
    return lines.join('\n');
  }
  function downloadCSV(csv, name){
    const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv], {type:'text/csv'})),download:name});
    a.click();
  }
  function downloadJSON(obj,name){
    const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)], {type:'application/json'})),download:name});
    a.click();
  }
  
  const escmap = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#47;'};
  const escapeHTML = s => String(s).replace(/[&<>"'/]/g,m=>escmap[m]);
  const csv = s => `"${String(s).replace(/"/g,'""')}"`;
  
  function toast(msg){
    const div = document.createElement('div');
    Object.assign(div.style,{ position:'fixed',bottom:'30px',left:'50%',transform:'translateX(-50%)', background:'#10b981', padding:'10px 20px', borderRadius:'30px', color:'#064e3b', fontWeight:'600', zIndex:9999, boxShadow:'0 5px 15px rgba(0,0,0,0.3)' });
    div.textContent = msg; document.body.appendChild(div);
    setTimeout(()=>div.remove(),2000);
  }

  // --- FUNGSI EXPORT EXCEL FINAL (FIX STAMPING UPDOWN & ROLL) ---
  async function exportToExcelStyled() {
    const btn = document.getElementById('btnExportXLSX');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Sedang Generate...';

    try {
      const startDate = new Date($tgl.value);
      const dates = [];
      const headerDates = [];
      
      for(let i=0; i<6; i++) {
        const d = new Date(startDate);
        d.setDate(startDate.getDate() + i);
        const iso = d.toISOString().slice(0,10);
        dates.push(iso);
        headerDates.push(d.getDate().toString()); 
      }

      const { data: rawData, error } = await supa
        .from('daily_rekap')
        .select('*')
        .in('work_date', dates)
        .order('process_sort');
        
      if(error) throw error;

      // HELPER: Normalisasi Nama (Hapus spasi, kecilkan huruf)
      const norm = s => String(s).trim().toLowerCase().replace(/\s+/g,'');

      // MAPPING DATA: "Laci Terpisah per Center"
      // Structure: dataMap[normalized_name][date][center_name] = data
      const dataMap = {};
      rawData.forEach(r => {
        const key = norm(r.process_name);
        if(!dataMap[key]) dataMap[key] = {};
        if(!dataMap[key][r.work_date]) dataMap[key][r.work_date] = {};
        
        // Simpan data di laci center masing-masing
        dataMap[key][r.work_date][r.center] = r;
      });

      // === CONFIG MERGE ===
      // Ini daftar nama yang BOLEH ngambil dari center tetangga
      const mergers = [
        { src: "Operator Bahan", dest: "Injection" },
        { src: "Operator Bahan", dest: "Inject" },
        { src: "Stamping Logo",  dest: "Logo" } 
      ];

      // Filter List Proses (Jangan tampilkan sumber merge di list utama)
      const blacklist = mergers.map(m => norm(m.src));
      const excelProcs = PROC.filter(p => !blacklist.includes(norm(p.name)));

      // Susun Excel
      const wsData = [ ["", "", "Tanggal", "", "", "", "", ""] ];
      const rowDates = ["Proses", "Status", ...headerDates];
      wsData.push(rowDates);

      const merges = [ { s: {r:0, c:2}, e: {r:0, c:7} } ]; 
      let currentRow = 2;

      excelProcs.forEach((proc, procIndex) => {
        const pName = proc.name;
        const key = norm(pName); // Pake kunci normalisasi

        if (procIndex > 0) { wsData.push([""]); currentRow++; } // Spacer

        ['tetap', 'kontrak', 'yayasan'].forEach((type, idx) => {
          const row = [];
          if(idx === 0) {
            row.push(pName);
            merges.push({ s: {r: currentRow, c: 0}, e: {r: currentRow + 2, c: 0} });
          } else {
            row.push(""); 
          }
          row.push(type);

          dates.forEach(dateISO => {
            // 1. AMBIL DATA UTAMA (HANYA DARI CENTER SAAT INI)
            // Ini kunci perbaikan Stamping Up Down & Roll
            const dateEntries = dataMap[key] && dataMap[key][dateISO];
            let val = 0;
            
            // Ambil data milik center ini (misal Injection)
            if(dateEntries && dateEntries[CENTER]) {
               val = Number(dateEntries[CENTER][type] || 0);
            }

            // 2. CEK APAKAH PERLU MERGE?
            const mergeRule = mergers.find(m => norm(m.dest) === key);
            if(mergeRule) {
               // Cari data sumber (misal Operator Bahan)
               const srcKey = norm(mergeRule.src);
               const srcEntries = dataMap[srcKey] && dataMap[srcKey][dateISO];
               
               if(srcEntries) {
                 // Jumlahkan semua data sumber dari center manapun (misal dr Assembly)
                 Object.values(srcEntries).forEach(srcRow => {
                    val += Number(srcRow[type] || 0);
                 });
               }
            }

            row.push(val);
          });

          wsData.push(row);
          currentRow++;
        });
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      ws['!merges'] = merges;

      // Styling
      const range = XLSX.utils.decode_range(ws['!ref']);
      const styleHeader = { fill: { fgColor: { rgb: "BDD7EE" } }, font: { bold: true, sz: 11 }, alignment: { horizontal: "center", vertical: "center" }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
      const styleProcess = { font: { bold: true }, alignment: { vertical: "center", horizontal: "left" }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
      const styleType = { fill: { fgColor: { rgb: "FCE4D6" } }, font: { bold: true }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };
      const styleData = { alignment: { horizontal: "center" }, border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} } };

      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddr = XLSX.utils.encode_cell({r: R, c: C});
          if (!ws[cellAddr]) ws[cellAddr] = { t: 's', v: '' };
          
          let cellStyle = {...styleData};
          if (R <= 1 && C >= 2) cellStyle = styleHeader;
          else if (C === 0 && R >= 2) cellStyle = styleProcess;
          else if (C === 1 && R >= 2) cellStyle = styleType;
          
          ws[cellAddr].s = cellStyle;
        }
      }

      ws['!cols'] = [ { wch: 20 }, { wch: 10 }, { wch: 5 }, { wch: 5 }, { wch: 5 }, { wch: 5 }, { wch: 5 }, { wch: 5 } ];

      XLSX.utils.book_append_sheet(wb, ws, "Laporan Produksi");
      XLSX.writeFile(wb, `Laporan_${CENTER}_${dates[0]}_sd_${dates[5]}.xlsx`);
      toast('File Excel berhasil didownload! ðŸ“¥');

    } catch (e) {
      console.error(e);
      alert('Gagal export Excel: ' + e.message);
    } finally {
      btn.innerHTML = originalText;
    }
  }

  refresh();
</script>

<script type="module" src="sw-register.js"></script>
</body>
</html>
